{% extends 'core/base.html' %}

{% block title %}{{ product.name }} - Мармерадости{% endblock %}

{% block content %}
<!-- Хлебные крошки -->
<nav aria-label="breadcrumb" class="bg-pink-light py-3">
    <div class="container">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{% url 'core:home' %}" class="text-decoration-none">Главная</a></li>
            <li class="breadcrumb-item"><a href="{% url 'core:product_list' %}" class="text-decoration-none">Каталог</a></li>
            {% if product.category %}
            <li class="breadcrumb-item"><a href="{% url 'core:category_products' product.category.id %}" class="text-decoration-none">{{ product.category.name }}</a></li>
            {% endif %}
            <li class="breadcrumb-item active">{{ product.name }}</li>
        </ol>
    </div>
</nav>

<!-- Детальная страница товара -->
<section class="py-5">
    <div class="container">
        <div class="row">
            <!-- Изображение товара - УВЕЛИЧЕНО -->
            <div class="col-lg-7 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-body p-4 text-center">
                        {% if product.image %}
                        <img src="{{ product.image.url }}" class="img-fluid rounded product-detail-image" alt="{{ product.name }}">
                        {% else %}
                        <div class="bg-gradient-custom rounded d-flex align-items-center justify-content-center product-detail-placeholder">
                            <i class="bi bi-emoji-sunglasses display-1 text-white"></i>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Информация о товаре -->
            <div class="col-lg-5 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <!-- Заголовок и категория -->
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h1 class="h2 text-primary-custom brand-font">{{ product.name }}</h1>
                            {% if product.category %}
                            <span class="badge bg-primary-custom fs-6">{{ product.category.name }}</span>
                            {% endif %}
                        </div>

                        <!-- Цена -->
                        <div class="mb-4 p-3 bg-pink-light rounded">
                            <h2 class="text-primary-custom display-5 fw-bold mb-1">{{ product.price }} ₽</h2>
                            <p class="text-muted mb-0 fs-5">за упаковку {{ product.weight }}г</p>
                        </div>

                        <!-- Описание -->
                        <div class="mb-4">
                            <h4 class="text-primary-custom mb-3">
                                <i class="bi bi-info-circle me-2"></i>Описание
                            </h4>
                            <p class="text-muted fs-6">{{ product.description }}</p>
                        </div>

                        <!-- Состав -->
                        {% if product.composition %}
                        <div class="mb-4">
                            <h4 class="text-primary-custom mb-3">
                                <i class="bi bi-list-check me-2"></i>Состав
                            </h4>
                            <p class="text-muted fs-6">{{ product.composition }}</p>
                        </div>
                        {% endif %}

                        <!-- Форма добавления в корзину -->
                        <div class="card bg-pink-light border-0 mt-4">
                            <div class="card-body">
                                <h5 class="text-primary-custom mb-3 fs-5">
                                    <i class="bi bi-cart-plus me-2"></i>Добавить в заказ
                                </h5>
                                
                                {% if user.is_authenticated %}
                                <form method="post" action="{% url 'core:cart_add_with_quantity' product.id %}">
                                    {% csrf_token %}
                                    <div class="row align-items-center">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label text-primary-custom fw-bold fs-6">Количество:</label>
                                            <div class="input-group input-group-lg">
                                                <button type="button" class="btn btn-outline-primary-custom quantity-minus" 
                                                        onclick="decreaseQuantity()">
                                                    <i class="bi bi-dash"></i>
                                                </button>
                                                <input type="number" name="quantity" id="quantity" 
                                                       class="form-control text-center fs-5" value="1" min="1" max="100">
                                                <button type="button" class="btn btn-outline-primary-custom quantity-plus" 
                                                        onclick="increaseQuantity()">
                                                    <i class="bi bi-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <button type="submit" class="btn btn-primary-custom btn-lg w-100 py-3">
                                                <i class="bi bi-cart-plus me-2"></i>Добавить в корзину
                                            </button>
                                        </div>
                                    </div>
                                </form>
                                {% else %}
                                <div class="text-center py-3">
                                    <p class="text-muted mb-3 fs-6">Для заказа товара необходимо авторизоваться</p>
                                    <div class="d-grid gap-2">
                                        <a href="{% url 'core:login' %}?next={{ request.path }}" 
                                           class="btn btn-primary-custom">
                                            <i class="bi bi-box-arrow-in-right me-2"></i>Войти в аккаунт
                                        </a>
                                        <a href="{% url 'core:register' %}" class="btn btn-outline-primary-custom">
                                            <i class="bi bi-person-plus me-2"></i>Зарегистрироваться
                                        </a>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Дополнительная информация -->
                        <div class="mt-4 pt-3 border-top">
                            <div class="row text-center">
                                <div class="col-4">
                                    <i class="bi bi-truck text-primary-custom fs-2"></i>
                                    <p class="small text-muted mb-0 mt-2">Быстрая доставка</p>
                                </div>
                                <div class="col-4">
                                    <i class="bi bi-shield-check text-primary-custom fs-2"></i>
                                    <p class="small text-muted mb-0 mt-2">Гарантия качества</p>
                                </div>
                                <div class="col-4">
                                    <i class="bi bi-arrow-left-right text-primary-custom fs-2"></i>
                                    <p class="small text-muted mb-0 mt-2">Легкий возврат</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Кнопка возврата -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <a href="{% if product.category %}{% url 'core:category_products' product.category.id %}{% else %}{% url 'core:product_list' %}{% endif %}" 
                   class="btn btn-outline-primary-custom btn-lg">
                    <i class="bi bi-arrow-left me-2"></i>Вернуться к категории
                </a>
            </div>
        </div>
    </div>
</section>

<script>
function increaseQuantity() {
    const quantityInput = document.getElementById('quantity');
    let quantity = parseInt(quantityInput.value);
    if (quantity < 100) {
        quantityInput.value = quantity + 1;
    }
}

function decreaseQuantity() {
    const quantityInput = document.getElementById('quantity');
    let quantity = parseInt(quantityInput.value);
    if (quantity > 1) {
        quantityInput.value = quantity - 1;
    }
}

// Обработка прямого ввода
document.getElementById('quantity').addEventListener('change', function() {
    let value = parseInt(this.value);
    if (isNaN(value) || value < 1) {
        this.value = 1;
    } else if (value > 100) {
        this.value = 100;
    }
});
</script>

<style>
.product-detail-image {
    max-height: 700px;
    width: auto;
    object-fit: contain;
}

.product-detail-placeholder {
    height: 600px;
    width: 100%;
}

.quantity-minus, .quantity-plus {
    width: 50px;
    font-weight: bold;
}

#quantity {
    font-weight: bold;
    font-size: 1.2rem;
}

.input-group {
    max-width: 220px;
}

/* Адаптивность для мобильных */
@media (max-width: 768px) {
    .product-detail-image {
        max-height: 400px;
    }
    
    .product-detail-placeholder {
        height: 300px;
    }
    
    .input-group {
        max-width: 100%;
    }
}

/* Улучшение внешнего вида карточек */
.card {
    border-radius: 15px;
}

.btn-lg {
    border-radius: 10px;
}

.bg-pink-light {
    border-radius: 10px;
}
</style>
{% endblock %}